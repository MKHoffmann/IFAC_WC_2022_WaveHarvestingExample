\section{Methods}

\subsection{Discretisation and simplification of the \ac{ocp}}
In order to solve the Problem~\ref{prob:ocp}, we employ direct methods for optimal control to first formulate the \ac{ocp} as a \ac{nlp} (see \cite{Gerdts2011OC}).\ 
Using gradient-based methods, the discretised optimal control sequence is calculated.\ 
The integral terms inside the cost functions have to be approximated.\ 
We do so by adding the integrand to the dynamics
\begin{align*}
	\dot{\Upsilon}_1 &= B_h\delta^2 +z^\intercal S_r z +\dfrac{u}{R_0} - d \delta \nonumber\\
	\dot{\Upsilon}_2 &= \left(\max \{ u-E_{th}^2 h_l^2,0 \} \right)^{n_d},
\end{align*}\ 
with
\begin{align*}
	\Upsilon_1(0) = \Upsilon_2(0) = 0.
\end{align*}
Remark, that the term $\cos^2(\theta)$ is simplified to 1, the same is done in the constraint on $u$.
The extended state reads
$\xvek = \begin{bmatrix}
	{\theta} &
	{\vartheta} & 
	{z{^\intercal}} &
	{\Upsilon_1} &
	{\Upsilon_2}
\end{bmatrix}^\intercal$, with the initial value $\xvek_0 = \begin{bmatrix}
{\theta_0} &
{\vartheta_0} & 
{z_0{^\intercal}} &
{0} &
{0}
\end{bmatrix}^\intercal$

In the following, the discretised values corresponding to their continuous counterparts are marked by square brackets, e.g. the state vector $\xvek[k]$, the extended state $k$ time steps into the future.\ 
The current state of the system is advanced by one step into the future using the classical Runge-Kutta-Method of 4-th order (RK4), denoted by $F_{RK4}(\xvek[k], u[k], u[k+1], d[k], d[k+1])$.\ 
Consecutive values for the input and wave excitation are used to model \ac{foh} behaviour.\ 
The dynamics can then be expressed with the equality constraints
\begin{align*}
	\xvek[k+1] = F_{RK4}(\xvek[k], u[k], u[k+1], d[k], d[k+1]) \\
	\forall k\in\left[0,N-2]\right]\\
	\xvek[0] = \xvek_0,
\end{align*}
where $N$ is the number of time steps $t_f$ is separated into.\ 
The cost functions are then $J_1 \approx \Upsilon_1[N-1]$ and $J_2 \approx \Upsilon_2[N-1]$, so that the \ac{moocp} is
\begin{problem}\label{pb:problem_disc}
%	The constrained discrete-time minimisation problem with scalarised multi-objective cost is given by 
	\begin{align}\label{eq:problem2}
		\minimize_{u[1],\ldots,u[N]} \ &w_1 J_1 + w_2 J_2 \nonumber\\
		\ \st \ & \xvek[k+1] = F_{RK4}(\xvek[k], u[k], u[k+1],\dots\nonumber\\ &d[k]), d[k+1])  \forall \ k \in [0, N-2], \nonumber\\
		&0 \le  u[k] \le (E_{bd} h_l)^2, \ \forall \ k \in [0, N-1]\\
		& \xvek[0] = \xvek_0\\
		& u[0] = u_0,
	\end{align}
\end{problem}
where $u_0$ is a fixed initial value of 0 for the very first and $u_\mathrm{MPC}[k-1]$ for the $k$-th MPC-step. \todo{understandable?}\
The values for $\Psi$ are dropped.\ 
Since $\Psi(0)$ is a constant for the \ac{foh} formulation, it does not change the optimization problem.\ 
Regarding $\Psi(\tf)$, $I_\mathrm{h}, K_\mathrm{h}$ are multiple magnitudes larger than $C_0$, so their terms dominate the expression of $\Psi$.\ 
The quadratic cost terms push the solution to the equilibrium position $\theta = 0$ at the end of the prediction horizon, an effect unwanted in continuous operation.

\subsection{Wave generation}
The stochastic wave is modeled as a superposition of $n$ scaled and shifted sine waves. The amplitude scaling aims to reconstruct the Brentschneider wave spectrum which in its general form reads
\begin{equation}
S_w(w)=A_B w^{-5} \exp \left(-B_B w^{-4}\right).
\end{equation}
The Brentschneider spectrum describes an average sea state when more specific climatic conditions are not available. 
It can be shown that when sufficiently many sine waves are used and the amplitudes of the sine waves fulfill
\begin{equation}
A_i=\sqrt{2 S_\omega\left(\omega_i\right) \Delta \omega_i}
\end{equation}
the final wave will correspond to the desired spectral distribution.
The parameters $A_b$ and $B_B$ can be modified to yield a wave with the desired overall force and frequency profile. Since for this paper, no specific sea state is emulated, the parameters have been chosen in such a way as to keep the resulting model trajectories within the modeling bounds.\\
Next, a random face-shift, $\Phi(t)$ is applied to the sine waves. 
To eradicate any periodicities that may arise, $\Phi(t)$ changes slowly over time. 
\\
Finally, the sine waves are multiplied with an excitation coefficient $\Gamma_w(w)$ to model the response of the flap to the wave. 
The disturbance of the flap can be written as 
\begin{equation}
    d(t)=\sum_{i = 1}^{n} \Gamma_{\mathrm{w}}(w_i) A_i(w_i) \sin \left(\omega_i t+\phi_i(t)\right).
\end{equation}
and \figref{fig:ExampleWave} shows the disturbance torgue generated by an example wave.
\begin{figure}[htb]
	\centering
	\fontsize{8}{0}\selectfont
	\def\svgwidth{0.49\textwidth}
	\input{images/wave_excitation.pdf_tex}
	\caption{Example of wave exitation applied to the flap}
	\label{fig:ExampleWave}
\end{figure}

\subsection{Adaptive weight selection}
When applying \ac{mpc}, we do not know exactly how the system will perform over the deployment of the control.\ 
In the case of the WEC-DEG when driving the system with a fixed weighting, different sea states will result in a different damage accumulation over time.\ 
Since the \ac{deg} has to be replaced once it breaks down, an operator of multiple \acp{deg} might be interested replacing all of the devices at the same time to save monetary costs.\ 
This means, that the breakdown of all the devices has to be synced, e.g. by changing the weighting of the damage cost function in a way, such that the accumulated damage cost at the designated break-down time \tbd does not exceed a fixed value $\Jd$.\ 

Assume a fixed set $w$ of \nw weight combinations sorted from low to high priority for the handled cost function (in our case $J_2$) and an initial weight index $\iw \in [1, \nw]$.\ 
One easy way of deciding, if the damage goal is achievable with the current weighting is by evaluating the \ac{mpc} performance over $N_p$ time steps into the past.\ 
The average rate of damage accumulation \Jps is estimated and the damage at the break-down time is predicted as an average trend.\
If the predicted damage exceeds \Jd, \iw is decreased by 1.\ 
Otherwise, if the predicted damage falls below $c_\mathrm{d}\Jd$ with $c_\mathrm{d}\in\left[0, 1\right]$, \iw is increased by 1.
This is done every $N_p$ steps if the \ac{deg} was actuated during that time.\
Of course, this algorithm just evaluates the performance in hindsight, not using the full potential of MPC.\ 
Still, we show that even this very simple heuristic can perform quite well, motivating more elaborate adaptation algorithms.
%Algorithm~\ref{alg:w_select} shows the selection, where $k$ is the current time step.
%
%\todo{is probably not necessary with the repo}
%\begin{algorithm2e}\label{alg:w_select}
%	\caption{Weight selection for $i$-th cost function}
%	\KwIn{$\Jd, \tbd, \iw, \nw, J^\mathrm{r}_i, \mud, N_p, \Delta t, k$}
%	\KwOut{\iw}
%	\If{$k+1 \; \mathrm{mod} \; N_p = 0$}{
%		$\Jps \gets \frac{1}{N_p\Delta t} \sum_{l=0}^{N_p-1} J_i^\mathrm{r}[k-l]$\;
%		\uIf{$\sum_{l=0}^{j} + \Jps(\tbd - k\Delta t) > \Jd$ and $\iw < \nw$}{
%			$\iw = \iw+1$
%		}\ElseIf{$\sum_{l=0}^{j} + \Jps(\tbd - k\Delta t) > \Jd$ and $\iw > 1$}{
%			$\iw = \iw-1$
%		}
%	}
%\end{algorithm2e}

For an exemplary implementation in MATLAB using the mentioned system, refer to \todo{link}.
